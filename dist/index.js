'use strict';module.exports=function(_ref){var a=_ref.keystone,b=_ref.connectionString,c=_ref.liveUrl,d=_ref.previewUrl,e=_ref.showLiveContentUrl,f=_ref.publishCheckedByDefault,g=_ref.forcePublishRegardlessOfStatus,h=void 0,i=process.env.MONGO_URI||a.get('mongo'),j=i===b;a.List.prototype.oldRegister=a.List.prototype.register;var k=function(n){return new Promise(function(o,p){if(h)o(h);else{var r=a.mongoose.createConnection(n,{server:{socketOptions:{keepAlive:3e5,connectTimeoutMS:3e4}},replset:{socketOptions:{keepAlive:3e5,connectTimeoutMS:3e4}}});r.on('open',function(s){s?p(s):(h=r,o(h))}),r.on('close',function(){h=void 0})}})};a.List.prototype.register=function(){var n=this;if(this.options.inherits)return void this.oldRegister();['noedit','nocreate','nodelete'].forEach(function(s){n.options[s]=n.options[s]||j});var o=this.options.publishable&&this.options.publishable.path,p=this.options.publishable&&this.options.publishable.publishByDefault,q=this.options.publishable&&this.options.publishable.noUnpublish,r=this.options.publishable&&this.options.publishable.trackPublishDate;l(this,{urlPath:o,publishByDefault:p,noUnpublish:q,trackPublishDate:r}),this.oldRegister(),m(this,{urlPath:o,publishByDefault:p,trackPublishDate:r})};var l=function(n,_ref2){var o=_ref2.urlPath,p=_ref2.publishByDefault,q=_ref2.noUnpublish,r=_ref2.trackPublishDate;n.add({heading:'Publishing Workflow'},{publish__status:{label:'Publishing Status',type:a.Field.Types.Select,options:[{value:'unpublished',label:'Unpublished'},{value:'published',label:'Published'},{value:'draft',label:'Draft'}],default:'unpublished',noedit:!0,index:!0}}),n.schema.index({publish__status:1}),r&&(n.add({publish__date:{type:a.Field.Types.Date,label:'Published Date',utc:!0},publish__displayDate:{type:a.Field.Types.Text,label:'Displayed Date',note:'Use this field to override the autogenerated formatted Published Date (MM/DD/YYYY) on the website. The website will display the date exactly as entered above.'}}),n.schema.index({publish__date:-1}),n.schema.index({publish__date:1})),n.add({publish__previewUrl:{label:'Preview URL',type:a.Field.Types.Url,noedit:!0,hidden:j||!o||d===void 0,dependsOn:{publish__status:['unpublished','draft']}},publish__liveUrl:{label:'Live URL',type:a.Field.Types.Url,noedit:!0,hidden:j||!o||c===void 0,dependsOn:{publish__status:['published']}},publish__contentUrl:{label:'Content URL',type:a.Field.Types.Url,noedit:!0,hidden:j||!1===e||c===void 0,dependsOn:{publish__status:['published']}},publish__publishOnSave:{label:'Publish on save',type:Boolean,default:!0===f||!0===p,hidden:j},publish__unpublishOnSave:{label:'Unpublish on save',type:Boolean,dependsOn:{publish__status:'published',publish__publishOnSave:!1},hidden:j||q},publish__rollbackOnSave:{label:'Rollback draft to live version',type:Boolean,dependsOn:{publish__status:'draft',publish__publishOnSave:!1},hidden:j}})},m=function(n,_ref3){var o=_ref3.urlPath,p=_ref3.publishByDefault,q=_ref3.trackPublishDate,r=n.options.schema.collection;n.schema.pre('save',function(H){var I=this,K=function J(){return g&&('published'===I.publish__status||I.publish__publishOnSave)||(I.saveWithSameStatus?'published'===I.publish__status:!I.isNew&&I.publish__publishOnSave)}(),L=I.publish__unpublishOnSave,M=I.publish__rollbackOnSave;I.publish__publishOnSave=!0===f||p,I.publish__unpublishOnSave=!1,I.publish__rollbackOnSave=!1,K?(I.publish__status='published',c&&(I.publish__contentUrl=s(I),o&&(I.publish__liveUrl=u(o,I))),A(I).then(H).catch(E(H))):M?C(I).then(function(N){Object.keys(N).map(function(O){I[O]=N[O]})}).then(H).catch(E(H)):(d&&o&&(I.publish__previewUrl=v(o,I)),L?(I.publish__status='unpublished',B(I).then(H).catch(E(H))):D(I).then(function(N){N&&(I.publish__status='draft')}).then(H).catch(E(H)))});var s=function(H){var I=H._doc._id;return c+'/keystone/'+n.path+'/'+I},t=function(H){return function(I,J){var L=/:([\w\-\.]+)/g;return(H+I).replace(L,function(M,N){return J[N]})}},u=t(c),v=function(H,I){return I.slug?t(d)(H,I):'Save to generate preview link'},w=function(H){return function(I){return k(b).then(function(J){return H(J,I)})}},z=function(H,I){return I.collection(r).findOne({_id:H._id})},A=w(function(H,I){return z(I,H).then(function(J){return null==J?H.collection(r).insert(I).then(function(){return H}):H.collection(r).update({_id:I._id},I).then(function(){return H})})}),B=w(function(H,I){return z(I,H).then(function(J){return null==J?Promise.resolve(H):H.collection(r).remove({_id:I._id}).then(function(){return H})})}),C=w(function(H,I){return z(I,H)}),D=w(function(H,I){return z(I,H).then(function(J){return null!=J&&F(I,J)})}),E=function(H){return function(I){console.warn('Error with Database Operation: ',I),H(new Error('There was an error saving. Please try again.'))}},F=function(H,I){var J=H.toObject();return!G(J,I)},G=function(H,I){if(null===H||H===void 0||null===I||I===void 0)return H===I;if(H.constructor!==I.constructor)return!1;if(H instanceof Function)return H===I;if(H instanceof RegExp)return H===I;if(H===I||H.valueOf()===I.valueOf())return!0;if(Array.isArray(H)&&H.length!==I.length)return!1;if(H instanceof Date)return!1;if(!(H instanceof Object))return!1;if(!(I instanceof Object))return!1;var J=function(N){return!{updatedAt:!0}[N]},K=Object.keys(H).filter(J),L=Object.keys(I).filter(J),M=L.every(function(N){return-1!==K.indexOf(N)});return M&&L.every(function(N){return G(H[N],I[N])})}};return k(b)};